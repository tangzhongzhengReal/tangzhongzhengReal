<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="数据绑定逻辑架构Vue 的数据观察系统是基于发布者&#x2F;订阅者模式，数据更新触发刷新页面的过程主要依赖数据观察系统里铁三角关系。在这个系统中，主要角色分别是 Observer、Dep、Watcher 这三个对象，对于每一个角色在观察数据更新的流程中各自承担的职责需要深入进行理解。下面请出三个主角登场，来介绍一下它们： ObserverObserver 相当于观察目标类，在数据绑定逻辑架构中的职责是收集">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue 源码探究-数据绑定逻辑架构">
<meta property="og:url" content="http://yoursite.com/2019/03/24/vue-source-7/index.html">
<meta property="og:site_name" content="唐忠正">
<meta property="og:description" content="数据绑定逻辑架构Vue 的数据观察系统是基于发布者&#x2F;订阅者模式，数据更新触发刷新页面的过程主要依赖数据观察系统里铁三角关系。在这个系统中，主要角色分别是 Observer、Dep、Watcher 这三个对象，对于每一个角色在观察数据更新的流程中各自承担的职责需要深入进行理解。下面请出三个主角登场，来介绍一下它们： ObserverObserver 相当于观察目标类，在数据绑定逻辑架构中的职责是收集">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-03-23T16:00:00.000Z">
<meta property="article:modified_time" content="2020-09-05T15:34:44.419Z">
<meta property="article:author" content="唐忠正">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Vue 源码探究-数据绑定逻辑架构</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/tangzhongzhengReal">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/04/02/vue-source-8/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/03/23/vue-source-6/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/24/vue-source-7/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yoursite.com/2019/03/24/vue-source-7/&text=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/24/vue-source-7/&is_video=false&description=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Vue 源码探究-数据绑定逻辑架构&body=Check out this article: http://yoursite.com/2019/03/24/vue-source-7/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/24/vue-source-7/&name=Vue 源码探究-数据绑定逻辑架构&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">数据绑定逻辑架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Observer"><span class="toc-number">1.1.</span> <span class="toc-text">Observer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dep"><span class="toc-number">1.2.</span> <span class="toc-text">Dep</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Watcher"><span class="toc-number">1.3.</span> <span class="toc-text">Watcher</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Observer-1"><span class="toc-number">2.1.</span> <span class="toc-text">Observer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dep-1"><span class="toc-number">2.2.</span> <span class="toc-text">Dep</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Watcher-1"><span class="toc-number">2.3.</span> <span class="toc-text">Watcher</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Vue 源码探究-数据绑定逻辑架构
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">唐忠正</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-03-23T16:00:00.000Z" itemprop="datePublished">2019-03-24</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="数据绑定逻辑架构"><a href="#数据绑定逻辑架构" class="headerlink" title="数据绑定逻辑架构"></a>数据绑定逻辑架构</h2><p>Vue 的数据观察系统是基于发布者/订阅者模式，数据更新触发刷新页面的过程主要依赖数据观察系统里铁三角关系。在这个系统中，主要角色分别是 Observer、Dep、Watcher 这三个对象，对于每一个角色在观察数据更新的流程中各自承担的职责需要深入进行理解。下面请出三个主角登场，来介绍一下它们：</p>
<h3 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h3><p>Observer 相当于观察目标类，在数据绑定逻辑架构中的职责是收集需要观察的数据对象，进行变量存取器的包装，并递归地对每一个需要观察的对象注册发布者对象，再由发布者去注册相应的监视器。这里非常巧妙的是触发通知监视器数据更新的事件的注册，一般的发布订阅模式需要建立一个事件管理器或者调度中心来统一管理各种事件的注册，然而 Vue 的数据绑定不需要这样的机制，它借用 Object.defineProperty 方法来为每一个被监视的数据设置了存取器，依靠数据的存取行为自然地实现了事件的触发。在初始化 Vue 实例中设置的 data 属性时，对这些输入的数据对象对行了依赖追踪，包装后的变量存放在 _data 属性中，这个过程中发布者和监视器的依赖添加是不可见的；而通过配置 watch 属性显式设置的监视器，就可以在实例的 _watchers 私有属性中查看到。每个组件初始化后有一个唯一的 _watcher 对象，它是一个用来监视在 data 中注册的数据变动从而更新视图的监视器，它也默认被添加到了各属性的依赖监视数组中。在每个修改为可观察状态的属性中，都含有一个 Dep 实例即发布者，这个对象的 subs 属性就是用来存放依赖的所有监视器 Watcher 实例对象，subs 可以理解为订阅者，即所有订阅了该数据对象变动的监视器的数组集合。之所以需要在一开始为数据收集依赖，参考另一些开发者的总结是由于并非所有的数据都值得监视，要知道监视没有用到的数据就是对性能的浪费，在实例观察中也确实发现，页面中没有用到的属性，没有被初始化为依赖项，这样即便改变了它的数值，页面也不会触发多余的刷新。</p>
<h3 id="Dep"><a href="#Dep" class="headerlink" title="Dep"></a>Dep</h3><p>Dep 在 Vue 的数据观察者系统里充当发布者的角色，它不仅用来触发数据更新和建立依赖的事件，还用来存放每一个可监视数据所依赖的监视器，这个正是在第一步收集依赖时的重要一环。实例初始化的过程中收集了所有需要跟踪变化的数据，在运用 Observer 重新包装每一个属性的同时，创建了各自的 dep 对象，并在 get 和 set 方法中分别使用了 Dep 的两个方法：depend 建立依赖，notify 通知变动。另外 Dep 还负责维护依赖监视器的增减。在构造 Dep 类的过程中，定义了全局的 Dep.target 对象和 targetStack 数组，targetStack 数组是用来存放待执行的 watcher 栈，Dep.target 是用来指代当前的监视器，必须唯一，它的存在对于建立监视器的依赖起到重要作用，在重置数据的 getter 时，当它存在时才执行建立数据与监视器的依赖，即只有显式配置了 watch 或创建了 computed 变量时才会在实例的私有属性里看到监视器。</p>
<h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>Watcher 是这个架构中的监视器，充当观察者的角色。在 Vue 实例初始化的过程中，一定会默认创建一个监视器，这个监视器就是用来监视实例对象的数据变化用来更新视图的，实例的私有属性 _watcher 用来存放它。在创建可观察的数据时，每一个数据的 Dep 对象会收集监视器并建立依赖，当数据变化时，Dep 对象通知所有的监视器执行更新，执行更新有两种模式，如果依赖是通过配置 computed 变量创建的，则会立即触发相关的更新操作，如果数据的 dep.subs 数组中没有依赖的监视器，则默认惰性更新模式。Watcher 类最主要的作用是通知视图更新，众所周知视图的更新是非常花费时间，会影响程序性能，为了尽量减少视图更新导致的性能损失，在通知视图执行更新操作之前会有一个缓冲时段，在这个时段中会收集最后一次监视器收到的变更，减少不必要的重复更新，实现最优性能。</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="Observer-1"><a href="#Observer-1" class="headerlink" title="Observer"></a>Observer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Observer类用来附加到每个观察对象上。</span><br><span class="line">&#x2F;&#x2F; 将被观察目标对象的属性键名转换成存取器,</span><br><span class="line">&#x2F;&#x2F; 以此收集依赖和派发更新</span><br><span class="line">&#x2F;**</span><br><span class="line"> * Observer class that is attached to each observed</span><br><span class="line"> * object. Once attached, the observer converts the target</span><br><span class="line"> * object&#39;s property keys into getter&#x2F;setters that</span><br><span class="line"> * collect dependencies and dispatch updates.</span><br><span class="line"> *&#x2F;</span><br><span class="line"> &#x2F;&#x2F; 定义并导出 Observer 类</span><br><span class="line">export class Observer &#123;</span><br><span class="line">  &#x2F;&#x2F; 初始化观测对象，依赖对象，实例计数器三个实例属性</span><br><span class="line">  value: any;</span><br><span class="line">  dep: Dep;</span><br><span class="line">  vmCount: number; &#x2F;&#x2F; number of vms that has this object as root $data</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 构造函数接受被观测对象参数</span><br><span class="line">  constructor (value: any) &#123;</span><br><span class="line">    &#x2F;&#x2F; 将传入的观测对象赋予实例的value属性</span><br><span class="line">    this.value &#x3D; value</span><br><span class="line">    &#x2F;&#x2F; 创建新的Dep依赖对象实例赋予dep属性</span><br><span class="line">    this.dep &#x3D; new Dep()</span><br><span class="line">    &#x2F;&#x2F; 初始化实例的vmCount为0</span><br><span class="line">    this.vmCount &#x3D; 0</span><br><span class="line">    &#x2F;&#x2F; 将实例挂载到观测对象的&#39;__ob__‘属性上</span><br><span class="line">    def(value, &#39;__ob__&#39;, this)</span><br><span class="line">    &#x2F;&#x2F; 如果观测对象是数组</span><br><span class="line">    if (Array.isArray(value)) &#123;</span><br><span class="line">      &#x2F;&#x2F; 判断是否可以使用__proto__属性，以此甚至augment含糊</span><br><span class="line">      const augment &#x3D; hasProto</span><br><span class="line">        ? protoAugment</span><br><span class="line">        : copyAugment</span><br><span class="line">      &#x2F;&#x2F; 拦截原型对象并重新添加数组原型方法</span><br><span class="line">      &#x2F;&#x2F; 这里应该是为了修复包装存取器破坏了数组对象的原型继承方法的问题</span><br><span class="line">      augment(value, arrayMethods, arrayKeys)</span><br><span class="line">      &#x2F;&#x2F; 观察数组中的对象</span><br><span class="line">      this.observeArray(value)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; 遍历每一个对象属性转换成包装后的存取器</span><br><span class="line">      this.walk(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; walk方法用来遍历对象的每一个属性，并转化成存取器</span><br><span class="line">  &#x2F;&#x2F; 只在观测值是对象的情况下调用</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Walk through each property and convert them into</span><br><span class="line">   * getter&#x2F;setters. This method should only be called when</span><br><span class="line">   * value type is Object.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  walk (obj: Object) &#123;</span><br><span class="line">    const keys &#x3D; Object.keys(obj)</span><br><span class="line">    for (let i &#x3D; 0; i &lt; keys.length; i++) &#123;</span><br><span class="line">      &#x2F;&#x2F; 将每一个对象属性转换成存取器</span><br><span class="line">      defineReactive(obj, keys[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 观察数组对象</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Observe a list of Array items.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  observeArray (items: Array&lt;any&gt;) &#123;</span><br><span class="line">    &#x2F;&#x2F; 遍历每一个数组对象，并继续观察</span><br><span class="line">    for (let i &#x3D; 0, l &#x3D; items.length; i &lt; l; i++) &#123;</span><br><span class="line">      observe(items[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 下面是两个辅助函数，用来根据是否可以使用对象的 __proto__属性来拦截原型</span><br><span class="line">&#x2F;&#x2F; 函数比较简单，不详细解释了</span><br><span class="line">&#x2F;&#x2F; helpers</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Augment an target Object or Array by intercepting</span><br><span class="line"> * the prototype chain using __proto__</span><br><span class="line"> *&#x2F;</span><br><span class="line">function protoAugment (target, src: Object, keys: any) &#123;</span><br><span class="line">  &#x2F;* eslint-disable no-proto *&#x2F;</span><br><span class="line">  target.__proto__ &#x3D; src</span><br><span class="line">  &#x2F;* eslint-enable no-proto *&#x2F;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Augment an target Object or Array by defining</span><br><span class="line"> * hidden properties.</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;* istanbul ignore next *&#x2F;</span><br><span class="line">function copyAugment (target: Object, src: Object, keys: Array&lt;string&gt;) &#123;</span><br><span class="line">  for (let i &#x3D; 0, l &#x3D; keys.length; i &lt; l; i++) &#123;</span><br><span class="line">    const key &#x3D; keys[i]</span><br><span class="line">    def(target, key, src[key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; observe函数用来为观测值创建观察目标实例</span><br><span class="line">&#x2F;&#x2F; 如果成功被观察则返回观察目标，或返回已存在观察目标</span><br><span class="line">&#x2F;**</span><br><span class="line"> * Attempt to create an observer instance for a value,</span><br><span class="line"> * returns the new observer if successfully observed,</span><br><span class="line"> * or the existing observer if the value already has one.</span><br><span class="line"> *&#x2F;</span><br><span class="line"> &#x2F;&#x2F; 定义并导出observe函数，接受观测值和是否作为data的根属性两个参数</span><br><span class="line"> &#x2F;&#x2F; 返回Observer类型对象或空值</span><br><span class="line">export function observe (value: any, asRootData: ?boolean): Observer | void &#123;</span><br><span class="line">  &#x2F;&#x2F; 判断是否为所要求的对象，否则不继续执行</span><br><span class="line">  if (!isObject(value) || value instanceof VNode) &#123;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 定义Observer类型或空值的ob变量</span><br><span class="line">  let ob: Observer | void</span><br><span class="line">  &#x2F;&#x2F; 如果观测值具有__ob__属性，并且其值是Observer实例，将其赋予ob</span><br><span class="line">  if (hasOwn(value, &#39;__ob__&#39;) &amp;&amp; value.__ob__ instanceof Observer) &#123;</span><br><span class="line">    ob &#x3D; value.__ob__</span><br><span class="line">  &#125; else if (</span><br><span class="line">    &#x2F;&#x2F; 如果shouldObserve为真，且不是服务器渲染，观测值是数组或者对象</span><br><span class="line">    &#x2F;&#x2F; 观测值可扩展，且观测值不是Vue实例，则创建新的观察目标实例赋予ob</span><br><span class="line">    &#x2F;&#x2F; 这里发现了在Vue核心类创建实例的时候设置的_isVue的用途了</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !isServerRendering() &amp;&amp;</span><br><span class="line">    (Array.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">    Object.isExtensible(value) &amp;&amp;</span><br><span class="line">    !value._isVue</span><br><span class="line">  ) &#123;</span><br><span class="line">    ob &#x3D; new Observer(value)</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 如果asRootData为真且ob对象存在，ob.vmCount自增</span><br><span class="line">  if (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.vmCount++</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 返回ob</span><br><span class="line">  return ob</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; defineReactive函数用来为观测值包赚存取器</span><br><span class="line">&#x2F;**</span><br><span class="line"> * Define a reactive property on an Object.</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;&#x2F; 定义并导出defineReactive函数，接受参数观测源obj，属性key, 值val,</span><br><span class="line">&#x2F;&#x2F; 自定义setter方法customSetter，是否进行递归转换shallow五个参数</span><br><span class="line">export function defineReactive (</span><br><span class="line">  obj: Object,</span><br><span class="line">  key: string,</span><br><span class="line">  val: any,</span><br><span class="line">  customSetter?: ?Function,</span><br><span class="line">  shallow?: boolean</span><br><span class="line">) &#123;</span><br><span class="line">  &#x2F;&#x2F; 创建依赖对象实例</span><br><span class="line">  const dep &#x3D; new Dep()</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 获取obj的属性描述符</span><br><span class="line">  const property &#x3D; Object.getOwnPropertyDescriptor(obj, key)</span><br><span class="line">  &#x2F;&#x2F; 如果该属性不可配置则不继续执行</span><br><span class="line">  if (property &amp;&amp; property.configurable &#x3D;&#x3D;&#x3D; false) &#123;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 提供预定义的存取器函数</span><br><span class="line">  &#x2F;&#x2F; cater for pre-defined getter&#x2F;setters</span><br><span class="line">  const getter &#x3D; property &amp;&amp; property.get</span><br><span class="line">  const setter &#x3D; property &amp;&amp; property.set</span><br><span class="line">  &#x2F;&#x2F; 如果不存在getter或存在settter，且函数只传入2个参数，手动设置val值</span><br><span class="line">  &#x2F;&#x2F; 这里主要是Obserber的walk方法里使用的情况，只传入两个参数</span><br><span class="line">  if ((!getter || setter) &amp;&amp; arguments.length &#x3D;&#x3D;&#x3D; 2) &#123;</span><br><span class="line">    val &#x3D; obj[key]</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; 判断是否递归观察子对象，并将子对象属性都转换成存取器，返回子观察目标</span><br><span class="line">  let childOb &#x3D; !shallow &amp;&amp; observe(val)</span><br><span class="line">  &#x2F;&#x2F; 重新定义属性</span><br><span class="line">  Object.defineProperty(obj, key, &#123;</span><br><span class="line">    enumerable: true,</span><br><span class="line">    configurable: true,</span><br><span class="line">    &#x2F;&#x2F; 设置getter</span><br><span class="line">    get: function reactiveGetter () &#123;</span><br><span class="line">      &#x2F;&#x2F; 如果预定义的getter存在则value等于getter调用的返回值</span><br><span class="line">      &#x2F;&#x2F; 否则直接赋予属性值</span><br><span class="line">      const value &#x3D; getter ? getter.call(obj) : val</span><br><span class="line">      &#x2F;&#x2F; 如果存在当前依赖目标，即监视器对象，则建立依赖</span><br><span class="line">      if (Dep.target) &#123;</span><br><span class="line">        dep.depend()</span><br><span class="line">        &#x2F;&#x2F; 如果子观察目标存在，建立子对象的依赖关系</span><br><span class="line">        if (childOb) &#123;</span><br><span class="line">          childOb.dep.depend()</span><br><span class="line">          &#x2F;&#x2F; 如果属性是数组，则特殊处理收集数组对象依赖</span><br><span class="line">          if (Array.isArray(value)) &#123;</span><br><span class="line">            dependArray(value)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 返回属性值</span><br><span class="line">      return value</span><br><span class="line">    &#125;,</span><br><span class="line">    &#x2F;&#x2F; 设置setter，接收新值newVal参数</span><br><span class="line">    set: function reactiveSetter (newVal) &#123;</span><br><span class="line">      &#x2F;&#x2F; 如果预定义的getter存在则value等于getter调用的返回值</span><br><span class="line">      &#x2F;&#x2F; 否则直接赋予属性值</span><br><span class="line">      const value &#x3D; getter ? getter.call(obj) : val</span><br><span class="line">      &#x2F;&#x2F; 如果新值等于旧值或者新值旧值为null则不执行</span><br><span class="line">      &#x2F;* eslint-disable no-self-compare *&#x2F;</span><br><span class="line">      if (newVal &#x3D;&#x3D;&#x3D; value || (newVal !&#x3D;&#x3D; newVal &amp;&amp; value !&#x3D;&#x3D; value)) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 非生产环境下如果customSetter存在，则调用customSetter</span><br><span class="line">      &#x2F;* eslint-enable no-self-compare *&#x2F;</span><br><span class="line">      if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; customSetter) &#123;</span><br><span class="line">        customSetter()</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 如果预定义setter存在则调用，否则直接更新新值</span><br><span class="line">      if (setter) &#123;</span><br><span class="line">        setter.call(obj, newVal)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        val &#x3D; newVal</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 判断是否递归观察子对象并返回子观察目标</span><br><span class="line">      childOb &#x3D; !shallow &amp;&amp; observe(newVal)</span><br><span class="line">      &#x2F;&#x2F; 发布变更通知</span><br><span class="line">      dep.notify()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 下面是单独定义并导出的动态增减属性时观测的函数</span><br><span class="line">&#x2F;&#x2F; set函数用来对程序执行中动态添加的属性进行观察并转换存取器，不详细解释</span><br><span class="line">&#x2F;**</span><br><span class="line"> * Set a property on an object. Adds the new property and</span><br><span class="line"> * triggers change notification if the property doesn&#39;t</span><br><span class="line"> * already exist.</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function set (target: Array&lt;any&gt; | Object, key: any, val: any): any &#123;</span><br><span class="line">  if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp;</span><br><span class="line">    (isUndef(target) || isPrimitive(target))</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(&#96;Cannot set reactive property on undefined, null, or primitive value: $&#123;(target: any)&#125;&#96;)</span><br><span class="line">  &#125;</span><br><span class="line">  if (Array.isArray(target) &amp;&amp; isValidArrayIndex(key)) &#123;</span><br><span class="line">    target.length &#x3D; Math.max(target.length, key)</span><br><span class="line">    target.splice(key, 1, val)</span><br><span class="line">    return val</span><br><span class="line">  &#125;</span><br><span class="line">  if (key in target &amp;&amp; !(key in Object.prototype)) &#123;</span><br><span class="line">    target[key] &#x3D; val</span><br><span class="line">    return val</span><br><span class="line">  &#125;</span><br><span class="line">  const ob &#x3D; (target: any).__ob__</span><br><span class="line">  if (target._isVue || (ob &amp;&amp; ob.vmCount)) &#123;</span><br><span class="line">    process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">      &#39;Avoid adding reactive properties to a Vue instance or its root $data &#39; +</span><br><span class="line">      &#39;at runtime - declare it upfront in the data option.&#39;</span><br><span class="line">    )</span><br><span class="line">    return val</span><br><span class="line">  &#125;</span><br><span class="line">  if (!ob) &#123;</span><br><span class="line">    target[key] &#x3D; val</span><br><span class="line">    return val</span><br><span class="line">  &#125;</span><br><span class="line">  defineReactive(ob.value, key, val)</span><br><span class="line">  ob.dep.notify()</span><br><span class="line">  return val</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Delete函数用来对程序执行中动态删除的属性发布变更通知，不详细解释</span><br><span class="line">&#x2F;**</span><br><span class="line"> * Delete a property and trigger change if necessary.</span><br><span class="line"> *&#x2F;</span><br><span class="line">export function del (target: Array&lt;any&gt; | Object, key: any) &#123;</span><br><span class="line">  if (process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp;</span><br><span class="line">    (isUndef(target) || isPrimitive(target))</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(&#96;Cannot delete reactive property on undefined, null, or primitive value: $&#123;(target: any)&#125;&#96;)</span><br><span class="line">  &#125;</span><br><span class="line">  if (Array.isArray(target) &amp;&amp; isValidArrayIndex(key)) &#123;</span><br><span class="line">    target.splice(key, 1)</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  const ob &#x3D; (target: any).__ob__</span><br><span class="line">  if (target._isVue || (ob &amp;&amp; ob.vmCount)) &#123;</span><br><span class="line">    process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">      &#39;Avoid deleting properties on a Vue instance or its root $data &#39; +</span><br><span class="line">      &#39;- just set it to null.&#39;</span><br><span class="line">    )</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  if (!hasOwn(target, key)) &#123;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  delete target[key]</span><br><span class="line">  if (!ob) &#123;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  ob.dep.notify()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 特殊处理数组的依赖收集的函数，递归的对数组中的成员执行依赖收集</span><br><span class="line">&#x2F;**</span><br><span class="line"> * Collect dependencies on array elements when the array is touched, since</span><br><span class="line"> * we cannot intercept array element access like property getters.</span><br><span class="line"> *&#x2F;</span><br><span class="line">function dependArray (value: Array&lt;any&gt;) &#123;</span><br><span class="line">  for (let e, i &#x3D; 0, l &#x3D; value.length; i &lt; l; i++) &#123;</span><br><span class="line">    e &#x3D; value[i]</span><br><span class="line">    e &amp;&amp; e.__ob__ &amp;&amp; e.__ob__.dep.depend()</span><br><span class="line">    if (Array.isArray(e)) &#123;</span><br><span class="line">      dependArray(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Dep-1"><a href="#Dep-1" class="headerlink" title="Dep"></a>Dep</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">let uid &#x3D; 0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; dep是个可观察对象，可以有多个指令订阅它</span><br><span class="line">&#x2F;**</span><br><span class="line"> * A dep is an observable that can have multiple</span><br><span class="line"> * directives subscribing to it.</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;&#x2F; 定义并导出Dep类</span><br><span class="line">export default class Dep &#123;</span><br><span class="line">  &#x2F;&#x2F; 定义变量</span><br><span class="line">  &#x2F;&#x2F; 私有变量，当前评估watcher对象</span><br><span class="line">  static target: ?Watcher;</span><br><span class="line">  &#x2F;&#x2F; dep实例Id</span><br><span class="line">  id: number;</span><br><span class="line">  &#x2F;&#x2F; dep实例监视器&#x2F;订阅者数组</span><br><span class="line">  subs: Array&lt;Watcher&gt;;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 定义构造器</span><br><span class="line">  constructor () &#123;</span><br><span class="line">    &#x2F;&#x2F; 初始化时赋予递增的id</span><br><span class="line">    this.id &#x3D; uid++</span><br><span class="line">    this.subs &#x3D; []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 定义addSub方法，接受Watcher类型的sub参数</span><br><span class="line">  addSub (sub: Watcher) &#123;</span><br><span class="line">    &#x2F;&#x2F; 向subs数组里添加新的watcher</span><br><span class="line">    this.subs.push(sub)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 定义removeSub方法，接受Watcher类型的sub参数</span><br><span class="line">  removeSub (sub: Watcher) &#123;</span><br><span class="line">    &#x2F;&#x2F; 从subs数组里移除指定watcher</span><br><span class="line">    remove(this.subs, sub)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 定义depend方法，将观察对象和watcher建立依赖</span><br><span class="line">  depend () &#123;</span><br><span class="line">    &#x2F;&#x2F; 在创建Wacther的时候会将在创建的Watcher赋值给Dep.target</span><br><span class="line">    &#x2F;&#x2F; 建立依赖时如果存在Watcher，则会调用Watcher的addDep方法</span><br><span class="line">    if (Dep.target) &#123;</span><br><span class="line">      Dep.target.addDep(this)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 定义notify方法，通知更新</span><br><span class="line">  notify () &#123;</span><br><span class="line">    &#x2F;&#x2F; 调用每个订阅者的update方法实现更新</span><br><span class="line">    &#x2F;&#x2F; stabilize the subscriber list first</span><br><span class="line">    const subs &#x3D; this.subs.slice()</span><br><span class="line">    for (let i &#x3D; 0, l &#x3D; subs.length; i &lt; l; i++) &#123;</span><br><span class="line">      subs[i].update()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Dep.target用来存放目前正在评估的watcher</span><br><span class="line">&#x2F;&#x2F; 全局唯一，并且一次也只能有一个watcher被评估</span><br><span class="line">&#x2F;&#x2F; the current target watcher being evaluated.</span><br><span class="line">&#x2F;&#x2F; this is globally unique because there could be only one</span><br><span class="line">&#x2F;&#x2F; watcher being evaluated at any time.</span><br><span class="line">Dep.target &#x3D; null</span><br><span class="line">&#x2F;&#x2F; targetStack用来存放watcher栈</span><br><span class="line">const targetStack &#x3D; []</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 定义并导出pushTarget函数，接受Watcher类型的参数</span><br><span class="line">export function pushTarget (_target: ?Watcher) &#123;</span><br><span class="line">  &#x2F;&#x2F; 入栈并将当前watcher赋值给Dep.target</span><br><span class="line">  if (Dep.target) targetStack.push(Dep.target)</span><br><span class="line">  Dep.target &#x3D; _target</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 定义并导出popTarget函数</span><br><span class="line">export function popTarget () &#123;</span><br><span class="line">  &#x2F;&#x2F; 出栈操作</span><br><span class="line">  Dep.target &#x3D; targetStack.pop()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Watcher-1"><a href="#Watcher-1" class="headerlink" title="Watcher"></a>Watcher</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br></pre></td><td class="code"><pre><span class="line">let uid &#x3D; 0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; watcher用来解析表达式，收集依赖对象，并在表达式的值变动时执行回调函数</span><br><span class="line">&#x2F;&#x2F; 全局的$watch()方法和指令都以同样方式实现</span><br><span class="line">&#x2F;**</span><br><span class="line"> * A watcher parses an expression, collects dependencies,</span><br><span class="line"> * and fires callback when the expression value changes.</span><br><span class="line"> * This is used for both the $watch() api and directives.</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;&#x2F; 定义并导出Watcher类</span><br><span class="line">export default class Watcher &#123;</span><br><span class="line">  &#x2F;&#x2F; 定义变量</span><br><span class="line">  vm: Component; &#x2F;&#x2F; 实例</span><br><span class="line">  expression: string; &#x2F;&#x2F; 表达式</span><br><span class="line">  cb: Function; &#x2F;&#x2F; 回调函数</span><br><span class="line">  id: number; &#x2F;&#x2F; watcher实例Id</span><br><span class="line">  deep: boolean; &#x2F;&#x2F; 是否深层依赖</span><br><span class="line">  user: boolean; &#x2F;&#x2F; 是否用户定义</span><br><span class="line">  computed: boolean; &#x2F;&#x2F; 是否计算属性</span><br><span class="line">  sync: boolean; &#x2F;&#x2F; 是否同步</span><br><span class="line">  dirty: boolean;  &#x2F;&#x2F; 是否为脏监视器</span><br><span class="line">  active: boolean; &#x2F;&#x2F; 是否激活中</span><br><span class="line">  dep: Dep; &#x2F;&#x2F; 依赖对象</span><br><span class="line">  deps: Array&lt;Dep&gt;; &#x2F;&#x2F; 依赖对象数组</span><br><span class="line">  newDeps: Array&lt;Dep&gt;; &#x2F;&#x2F; 新依赖对象数组</span><br><span class="line">  depIds: SimpleSet;  &#x2F;&#x2F; 依赖id集合</span><br><span class="line">  newDepIds: SimpleSet; &#x2F;&#x2F; 新依赖id集合</span><br><span class="line">  before: ?Function; &#x2F;&#x2F; 先行调用函数</span><br><span class="line">  getter: Function; &#x2F;&#x2F; 指定getter</span><br><span class="line">  value: any; &#x2F;&#x2F; 观察值</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 定义构造函数</span><br><span class="line">  &#x2F;&#x2F; 接收vue实例，表达式对象，回调函数，配置对象，是否渲染监视器5个参数</span><br><span class="line">  constructor (</span><br><span class="line">    vm: Component,</span><br><span class="line">    expOrFn: string | Function,</span><br><span class="line">    cb: Function,</span><br><span class="line">    options?: ?Object,</span><br><span class="line">    isRenderWatcher?: boolean</span><br><span class="line">  ) &#123;</span><br><span class="line">    &#x2F;&#x2F; 下面是对实例属性的赋值</span><br><span class="line">    this.vm &#x3D; vm</span><br><span class="line">    &#x2F;&#x2F; 如果是渲染监视器则将它赋值给实例的_watcher属性</span><br><span class="line">    if (isRenderWatcher) &#123;</span><br><span class="line">      vm._watcher &#x3D; this</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 添加到vm._watchers数组中</span><br><span class="line">    vm._watchers.push(this)</span><br><span class="line">    &#x2F;&#x2F; 如果配置对象存在，初始化一些配置属性</span><br><span class="line">    &#x2F;&#x2F; options</span><br><span class="line">    if (options) &#123;</span><br><span class="line">      this.deep &#x3D; !!options.deep</span><br><span class="line">      this.user &#x3D; !!options.user</span><br><span class="line">      this.computed &#x3D; !!options.computed</span><br><span class="line">      this.sync &#x3D; !!options.sync</span><br><span class="line">      this.before &#x3D; options.before</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; 否则将配属性设为false</span><br><span class="line">      this.deep &#x3D; this.user &#x3D; this.computed &#x3D; this.sync &#x3D; false</span><br><span class="line">    &#125;</span><br><span class="line">    this.cb &#x3D; cb</span><br><span class="line">    this.id &#x3D; ++uid &#x2F;&#x2F; uid for batching</span><br><span class="line">    this.active &#x3D; true</span><br><span class="line">    this.dirty &#x3D; this.computed &#x2F;&#x2F; for computed watchers</span><br><span class="line">    this.deps &#x3D; []</span><br><span class="line">    this.newDeps &#x3D; []</span><br><span class="line">    this.depIds &#x3D; new Set()</span><br><span class="line">    this.newDepIds &#x3D; new Set()</span><br><span class="line">    this.expression &#x3D; process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39;</span><br><span class="line">      ? expOrFn.toString()</span><br><span class="line">      : &#39;&#39;</span><br><span class="line">    &#x2F;&#x2F; 设置监视器的getter方法</span><br><span class="line">    &#x2F;&#x2F; parse expression for getter</span><br><span class="line">    &#x2F;&#x2F; 如果传入的expOrFn参数是函数直接赋值给getter属性</span><br><span class="line">    if (typeof expOrFn &#x3D;&#x3D;&#x3D; &#39;function&#39;) &#123;</span><br><span class="line">      this.getter &#x3D; expOrFn</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; 否则解析传入的表达式的路径，返回最后一级数据对象</span><br><span class="line">      &#x2F;&#x2F; 这里是支持使用点符号获取属性的表达式来获取嵌套需观测数据</span><br><span class="line">      this.getter &#x3D; parsePath(expOrFn)</span><br><span class="line">      &#x2F;&#x2F; 不存在getter则设置空函数</span><br><span class="line">      if (!this.getter) &#123;</span><br><span class="line">        this.getter &#x3D; function () &#123;&#125;</span><br><span class="line">        process.env.NODE_ENV !&#x3D;&#x3D; &#39;production&#39; &amp;&amp; warn(</span><br><span class="line">          &#96;Failed watching path: &quot;$&#123;expOrFn&#125;&quot; &#96; +</span><br><span class="line">          &#39;Watcher only accepts simple dot-delimited paths. &#39; +</span><br><span class="line">          &#39;For full control, use a function instead.&#39;,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 如果是计算属性，创建dep属性</span><br><span class="line">    if (this.computed) &#123;</span><br><span class="line">      this.value &#x3D; undefined</span><br><span class="line">      &#x2F;&#x2F;</span><br><span class="line">      this.dep &#x3D; new Dep()</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; 负责调用get方法获取观测值</span><br><span class="line">      this.value &#x3D; this.get()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 评估getter，并重新收集依赖项</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Evaluate the getter, and re-collect dependencies.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  get () &#123;</span><br><span class="line">    &#x2F;&#x2F; 将实例添加到watcher栈中</span><br><span class="line">    pushTarget(this)</span><br><span class="line">    let value</span><br><span class="line">    const vm &#x3D; this.vm</span><br><span class="line">    &#x2F;&#x2F; 尝试调用vm的getter方法</span><br><span class="line">    try &#123;</span><br><span class="line">      value &#x3D; this.getter.call(vm, vm)</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      &#x2F;&#x2F; 捕捉到错误时，如果是用户定义的watcher则处理异常</span><br><span class="line">      if (this.user) &#123;</span><br><span class="line">        handleError(e, vm, &#96;getter for watcher &quot;$&#123;this.expression&#125;&quot;&#96;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; 否则抛出异常</span><br><span class="line">        throw e</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      &#x2F;&#x2F; 最终执行“触摸”每个属性的操作，以便将它们全部跟踪为深度监视的依赖关系</span><br><span class="line">      &#x2F;&#x2F; &quot;touch&quot; every property so they are all tracked as</span><br><span class="line">      &#x2F;&#x2F; dependencies for deep watching</span><br><span class="line">      if (this.deep) &#123;</span><br><span class="line">        &#x2F;&#x2F; traverse方法递归每一个对象，将对象的每级属性收集为深度依赖项</span><br><span class="line">        traverse(value)</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 执行出栈</span><br><span class="line">      popTarget()</span><br><span class="line">      &#x2F;&#x2F; 调用实例cleanupDeps方法</span><br><span class="line">      this.cleanupDeps()</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 返回观测数据</span><br><span class="line">    return value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 添加依赖</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Add a dependency to this directive.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;&#x2F; 定义addDep方法，接收Dep类型依赖实例对象</span><br><span class="line">  addDep (dep: Dep) &#123;</span><br><span class="line">    const id &#x3D; dep.id</span><br><span class="line">    &#x2F;&#x2F; 如果不存在依赖，将新依赖对象id和对象添加进相应数组中</span><br><span class="line">    if (!this.newDepIds.has(id)) &#123;</span><br><span class="line">      this.newDepIds.add(id)</span><br><span class="line">      this.newDeps.push(dep)</span><br><span class="line">      &#x2F;&#x2F; 并在dep对象中添加监视器自身</span><br><span class="line">      if (!this.depIds.has(id)) &#123;</span><br><span class="line">        dep.addSub(this)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 清理依赖项集合</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Clean up for dependency collection.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;&#x2F; 定义cleanupDeps方法</span><br><span class="line">  cleanupDeps () &#123;</span><br><span class="line">    let i &#x3D; this.deps.length</span><br><span class="line">    &#x2F;&#x2F; 遍历依赖列表</span><br><span class="line">    while (i--) &#123;</span><br><span class="line">      const dep &#x3D; this.deps[i]</span><br><span class="line">      &#x2F;&#x2F; 如果监视器的依赖对象列表中含有当前依赖对象</span><br><span class="line">      &#x2F;&#x2F; 从依赖对象中移除该监视器</span><br><span class="line">      if (!this.newDepIds.has(dep.id)) &#123;</span><br><span class="line">        dep.removeSub(this)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 重置监视器的依赖相关属性，</span><br><span class="line">    &#x2F;&#x2F; 将新建立的依赖转换成常规依赖</span><br><span class="line">    &#x2F;&#x2F; 并清空新依赖列表</span><br><span class="line">    let tmp &#x3D; this.depIds</span><br><span class="line">    this.depIds &#x3D; this.newDepIds</span><br><span class="line">    this.newDepIds &#x3D; tmp</span><br><span class="line">    this.newDepIds.clear()</span><br><span class="line">    tmp &#x3D; this.deps</span><br><span class="line">    this.deps &#x3D; this.newDeps</span><br><span class="line">    this.newDeps &#x3D; tmp</span><br><span class="line">    this.newDeps.length &#x3D; 0</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 订阅者接口，当依赖项变更时调用</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Subscriber   .</span><br><span class="line">   * Will be called when a dependency changes.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;&#x2F; 定义update方法</span><br><span class="line">  update () &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果是计算属性</span><br><span class="line">    &#x2F;* istanbul ignore else *&#x2F;</span><br><span class="line">    if (this.computed) &#123;</span><br><span class="line">      &#x2F;&#x2F; 计算属性的观察有两种模式：懒模式和立即模式</span><br><span class="line">      &#x2F;&#x2F; 默认都设置为懒模式，要使用立即模式需要至少有一个订阅者，</span><br><span class="line">      &#x2F;&#x2F; 典型情况下是另一个计算属性或渲染函数</span><br><span class="line">      &#x2F;&#x2F; A computed property watcher has two modes: lazy and activated.</span><br><span class="line">      &#x2F;&#x2F; It initializes as lazy by default, and only becomes activated when</span><br><span class="line">      &#x2F;&#x2F; it is depended on by at least one subscriber, which is typically</span><br><span class="line">      &#x2F;&#x2F; another computed property or a component&#39;s render function.</span><br><span class="line">      &#x2F;&#x2F; 当不存在依赖列表</span><br><span class="line">      if (this.dep.subs.length &#x3D;&#x3D;&#x3D; 0) &#123;</span><br><span class="line">        &#x2F;&#x2F; 设置dirty属性为true，这是因为在懒模式下只在需要的时候才执行计算，</span><br><span class="line">        &#x2F;&#x2F; 所以为了稍后执行先把dirty属性设置成true,这样在属性被访问的时候</span><br><span class="line">        &#x2F;&#x2F; 才会执行真实的计算过程。</span><br><span class="line">        &#x2F;&#x2F; In lazy mode, we don&#39;t want to perform computations until necessary,</span><br><span class="line">        &#x2F;&#x2F; so we simply mark the watcher as dirty. The actual computation is</span><br><span class="line">        &#x2F;&#x2F; performed just-in-time in this.evaluate() when the computed property</span><br><span class="line">        &#x2F;&#x2F; is accessed.</span><br><span class="line">        this.dirty &#x3D; true</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; 在立即执行模式中，需要主动执行计算</span><br><span class="line">        &#x2F;&#x2F; 但只在值真正变化的时候才通知订阅者</span><br><span class="line">        &#x2F;&#x2F; In activated mode, we want to proactively perform the computation</span><br><span class="line">        &#x2F;&#x2F; but only notify our subscribers when the value has indeed changed.</span><br><span class="line">        &#x2F;&#x2F; 调用getAndInvoke函数，判断是否观测值真正变化，并发布更新通知</span><br><span class="line">        this.getAndInvoke(() &#x3D;&gt; &#123;</span><br><span class="line">          this.dep.notify()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (this.sync) &#123;</span><br><span class="line">      &#x2F;&#x2F; 如果同步执行，则调用实例run方法</span><br><span class="line">      this.run()</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; 否则将监视器添加进待评估队列</span><br><span class="line">      queueWatcher(this)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 调度工作接口，会被调度器调用</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Scheduler job interface.</span><br><span class="line">   * Will be called by the scheduler.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;&#x2F; 定义run方法</span><br><span class="line">  run () &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果当前监视器处于活跃状态，则立即调用getAndInvoke方法</span><br><span class="line">    if (this.active) &#123;</span><br><span class="line">      this.getAndInvoke(this.cb)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 定义getAndInvoke方法，接收一个回调函数参数</span><br><span class="line">  getAndInvoke (cb: Function) &#123;</span><br><span class="line">    &#x2F;&#x2F; 获取新观测值</span><br><span class="line">    const value &#x3D; this.get()</span><br><span class="line">    &#x2F;&#x2F; 当旧值与新值不相等，或者挂厕纸是对象，或需要深度观察时</span><br><span class="line">    &#x2F;&#x2F; 触发变更，发布通知</span><br><span class="line">    if (</span><br><span class="line">      value !&#x3D;&#x3D; this.value ||</span><br><span class="line">      &#x2F;&#x2F; 因为对象或数组即使相等时，其值可能发生变异所以也需要触发更新</span><br><span class="line">      &#x2F;&#x2F; Deep watchers and watchers on Object&#x2F;Arrays should fire even</span><br><span class="line">      &#x2F;&#x2F; when the value is the same, because the value may</span><br><span class="line">      &#x2F;&#x2F; have mutated.</span><br><span class="line">      isObject(value) ||</span><br><span class="line">      this.deep</span><br><span class="line">    ) &#123;</span><br><span class="line">      &#x2F;&#x2F; 更细观测值，并设置置否dirty属性</span><br><span class="line">      &#x2F;&#x2F; set new value</span><br><span class="line">      const oldValue &#x3D; this.value</span><br><span class="line">      this.value &#x3D; value</span><br><span class="line">      this.dirty &#x3D; false</span><br><span class="line">      &#x2F;&#x2F; 如果是用户自定义监视器，则在调用回调函数时设置错误捕捉</span><br><span class="line">      if (this.user) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          cb.call(this.vm, value, oldValue)</span><br><span class="line">        &#125; catch (e) &#123;</span><br><span class="line">          handleError(e, this.vm, &#96;callback for watcher &quot;$&#123;this.expression&#125;&quot;&#96;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        cb.call(this.vm, value, oldValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 评估和返回观测值方法，只在计算属性时被调用</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Evaluate and return the value of the watcher.</span><br><span class="line">   * This only gets called for computed property watchers.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;&#x2F; 定义evaluate方法</span><br><span class="line">  evaluate () &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果是计算属性，获取观测是，并返回</span><br><span class="line">    if (this.dirty) &#123;</span><br><span class="line">      this.value &#x3D; this.get()</span><br><span class="line">      this.dirty &#x3D; false</span><br><span class="line">    &#125;</span><br><span class="line">    return this.value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 建立监视器的依赖方法，只在计算属性调用</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Depend on this watcher. Only for computed property watchers.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;&#x2F; 定义depend方法</span><br><span class="line">  depend () &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果依赖对象存在且存在当前运行监视器，建立依赖</span><br><span class="line">    if (this.dep &amp;&amp; Dep.target) &#123;</span><br><span class="line">      this.dep.depend()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 销毁监视器方法，将自身从依赖数组中移除</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * Remove self from all dependencies&#39; subscriber list.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  &#x2F;&#x2F; 定义teardown方法</span><br><span class="line">  teardown () &#123;</span><br><span class="line">    &#x2F;&#x2F; 当监视器处于活跃状态，执行销毁</span><br><span class="line">    if (this.active) &#123;</span><br><span class="line">      &#x2F;&#x2F; 从监视器列表中移除监视器是高开销操作</span><br><span class="line">      &#x2F;&#x2F; 所以如果实例正在销毁中则跳过销毁</span><br><span class="line">      &#x2F;&#x2F; remove self from vm&#39;s watcher list</span><br><span class="line">      &#x2F;&#x2F; this is a somewhat expensive operation so we skip it</span><br><span class="line">      &#x2F;&#x2F; if the vm is being destroyed.</span><br><span class="line">      &#x2F;&#x2F; 当实例正常运行中，从监视器列表中移除监视器</span><br><span class="line">      if (!this.vm._isBeingDestroyed) &#123;</span><br><span class="line">        remove(this.vm._watchers, this)</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 从所有依赖列表中移除该监视器</span><br><span class="line">      let i &#x3D; this.deps.length</span><br><span class="line">      while (i--) &#123;</span><br><span class="line">        this.deps[i].removeSub(this)</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; 将监视器的活跃状态置否</span><br><span class="line">      this.active &#x3D; false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>本篇主要是关于源码的解释，可以翻看观察系统的原理篇来对照理解。</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/tangzhongzhengReal">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">数据绑定逻辑架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Observer"><span class="toc-number">1.1.</span> <span class="toc-text">Observer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dep"><span class="toc-number">1.2.</span> <span class="toc-text">Dep</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Watcher"><span class="toc-number">1.3.</span> <span class="toc-text">Watcher</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Observer-1"><span class="toc-number">2.1.</span> <span class="toc-text">Observer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dep-1"><span class="toc-number">2.2.</span> <span class="toc-text">Dep</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Watcher-1"><span class="toc-number">2.3.</span> <span class="toc-text">Watcher</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/24/vue-source-7/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yoursite.com/2019/03/24/vue-source-7/&text=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/24/vue-source-7/&is_video=false&description=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Vue 源码探究-数据绑定逻辑架构&body=Check out this article: http://yoursite.com/2019/03/24/vue-source-7/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yoursite.com/2019/03/24/vue-source-7/&title=Vue 源码探究-数据绑定逻辑架构"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/24/vue-source-7/&name=Vue 源码探究-数据绑定逻辑架构&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 唐忠正
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/tangzhongzhengReal">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<link rel="stylesheet" href="/lib/meslo-LG/styles.css">


<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>



    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-37473492-6', 'auto');
        ga('send', 'pageview');
    </script>



